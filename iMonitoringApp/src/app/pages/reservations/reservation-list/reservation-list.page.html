<ion-header [translucent]="true">
  <ion-toolbar class="bg-gray-100 dark:bg-kwd-dark-light">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/app/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title class="text-gray-900 dark:text-kwd-light font-bold">Gestión de Reservas</ion-title>
    <ion-buttons slot="end">
      <ion-button routerLink="/app/reservations/new">
        <ion-icon name="add-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding bg-gray-100 dark:bg-kwd-dark">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="p-4">

    <div class="bg-white dark:bg-[#152e4d] rounded-lg shadow-md p-4 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-kwd-light mb-3">Filtros</h2>
      <ion-item class="mb-3 dark:bg-kwd-dark dark:text-kwd-light rounded-md">
        <ion-label position="stacked">Estado</ion-label>
        <ion-select interface="popover" [(ngModel)]="selectedStatusFilter" (ionChange)="applyFilters()">
          <ion-select-option *ngFor="let status of availableStatuses" [value]="status.value">{{ status.label | titlecase }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item class="mb-3 dark:bg-kwd-dark dark:text-kwd-light rounded-md">
        <ion-label position="stacked">Aula</ion-label>
        <ion-select interface="popover" [(ngModel)]="selectedClassroomFilter" (ionChange)="applyFilters()">
          <ion-select-option value="ALL">Todas</ion-select-option>
          <ion-select-option *ngFor="let c of classrooms" [value]="c.id">{{ c.name }}</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item class="mb-3 dark:bg-kwd-dark dark:text-kwd-light rounded-md">
        <ion-label position="stacked">Buscar</ion-label>
        <ion-input type="text" [(ngModel)]="searchTerm" (ionChange)="applyFilters()" placeholder="Motivo, usuario o aula"></ion-input>
      </ion-item>
    </div>

    <ion-segment [(ngModel)]="selectedView" (ionChange)="segmentChanged($event)" class="bg-white dark:bg-[#152e4d] rounded-lg shadow-md p-4 mb-6">
      <ion-segment-button value="pending" *ngIf="userRole === RolEnum.ADMIN || userRole === RolEnum.COORDINADOR">
        <ion-label>Pendientes</ion-label>
      </ion-segment-button>
      <ion-segment-button value="my-reservations">
        <ion-label>Mis Reservas</ion-label>
      </ion-segment-button>
      <ion-segment-button value="all" *ngIf="userRole === RolEnum.ADMIN || userRole === RolEnum.COORDINADOR">
        <ion-label>Todas</ion-label>
      </ion-segment-button>
    </ion-segment>

    <div [ngSwitch]="selectedView">

      <ng-container *ngFor="let viewType of ['pending', 'my-reservations', 'all']">
        <div *ngSwitchCase="viewType">

            <div *ngIf="(viewType==='pending' && isLoadingPending) || (viewType==='my-reservations' && isLoadingMyReservations) || (viewType==='all' && isLoadingAllReservations)" class="flex justify-center h-48 items-center">
                <ion-spinner name="circles" color="primary"></ion-spinner>
            </div>

            <div *ngIf="
                (viewType==='pending' && !isLoadingPending && filteredPendingReservations.length === 0) ||
                (viewType==='my-reservations' && !isLoadingMyReservations && filteredMyReservations.length === 0) ||
                (viewType==='all' && !isLoadingAllReservations && filteredAllReservations.length === 0)"
                class="text-center text-gray-500 p-4">
                <p>No se encontraron reservas.</p>
            </div>

            <ion-list lines="none" class="space-y-3 bg-transparent">
                <ion-card *ngFor="let item of (viewType==='pending' ? filteredPendingReservations : (viewType==='my-reservations' ? filteredMyReservations : filteredAllReservations))"
                    class="dark:bg-kwd-darker shadow-lg rounded-xl overflow-hidden transition-shadow hover:shadow-xl">

                    <ion-item-sliding>
                        <ion-item button detail="false" class="dark:bg-kwd-darker p-3 cursor-pointer" (click)="viewReservationDetails(item)">
                            <ion-icon *ngIf="item.isGroup" name="repeat-outline" slot="start" class="text-3xl text-secondary opacity-80"></ion-icon>
                            <ion-icon *ngIf="!item.isGroup" name="calendar-outline" slot="start" class="text-3xl opacity-80" [style.color]="getStatusColor(item.status)"></ion-icon>

                            <ion-label class="dark:text-gray-200">
                                <h2 class="font-bold text-md">
                                    {{ item.title }}
                                    <span *ngIf="item.isGroup" class="text-xs font-normal text-gray-500 ml-1">({{ item.count }} clases)</span>
                                </h2>
                                <p class="text-xs text-gray-500"><ion-icon name="business-outline" class="mr-1 align-middle"></ion-icon> {{ item.subtitle }}</p>
                                <p class="text-xs text-gray-500"><ion-icon name="person-outline" class="mr-1 align-middle"></ion-icon> {{ item.userName }}</p>

                                <p class="text-xs text-gray-800 dark:text-gray-300 font-semibold mt-1">
                                    <ion-icon name="time-outline" class="mr-1 align-middle"></ion-icon>
                                    {{ item.dateDescription }} • {{ item.startTimeLabel }} - {{ item.endTimeLabel }}
                                </p>

                                <p class="text-xs mt-1">
                                    <span class="font-semibold py-0.5 px-1.5 rounded-md text-white text-[0.65rem]" [style.backgroundColor]="getStatusColor(item.status)">
                                        {{ item.status | titlecase }}
                                    </span>
                                </p>
                            </ion-label>
                        </ion-item>

                        <ion-item-options side="end">
                            <ion-item-option *ngIf="canApproveOrReject(item)" color="success" (click)="confirmAction(item, 'confirm')">
                                <ion-icon name="checkmark" slot="icon-only"></ion-icon>
                            </ion-item-option>
                            <ion-item-option *ngIf="canApproveOrReject(item)" color="danger" (click)="confirmAction(item, 'reject')">
                                <ion-icon name="close" slot="icon-only"></ion-icon>
                            </ion-item-option>
                            <ion-item-option *ngIf="canEditReservation(item)" color="warning" (click)="navigateToEdit(item)">
                                <ion-icon name="create" slot="icon-only"></ion-icon>
                            </ion-item-option>
                            <ion-item-option *ngIf="canCancelReservation(item)" color="light" (click)="confirmAction(item, 'cancel')">
                                <ion-icon name="trash" color="danger" slot="icon-only"></ion-icon>
                            </ion-item-option>
                        </ion-item-options>
                    </ion-item-sliding>

                    <div class="flex justify-end p-2 space-x-2 bg-gray-50 dark:bg-kwd-darker border-t border-gray-100 dark:border-gray-700">
                        <ion-button *ngIf="canApproveOrReject(item)" color="success" size="small" fill="clear" (click)="confirmAction(item, 'confirm')">Aprobar</ion-button>
                        <ion-button *ngIf="canApproveOrReject(item)" color="danger" size="small" fill="clear" (click)="confirmAction(item, 'reject')">Rechazar</ion-button>
                        <ion-button *ngIf="canCancelReservation(item)" color="medium" size="small" fill="clear" (click)="confirmAction(item, 'cancel')">Cancelar</ion-button>
                    </div>

                </ion-card>
            </ion-list>
        </div>
      </ng-container>

    </div>
  </div>
</ion-content>
