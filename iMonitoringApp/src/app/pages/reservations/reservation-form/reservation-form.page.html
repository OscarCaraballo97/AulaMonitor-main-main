<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/app/reservations"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ isEditMode ? 'Editar Reserva' : 'Nueva Reserva' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()">

    <div *ngIf="!isEditMode && isAdminOrCoordinator" class="mb-4">
      <ion-segment (ionChange)="segmentChanged($event)" [value]="reservationType">
        <ion-segment-button value="single">
          <ion-label>Individual</ion-label>
        </ion-segment-button>
        <ion-segment-button value="semester">
          <ion-label>Semestre</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <ion-item class="mb-2">
      <ion-label position="stacked">Aula</ion-label>
      <ion-select formControlName="classroomId" placeholder="Selecciona un aula">
        <ion-select-option *ngFor="let room of classrooms" [value]="room.id">
          {{ room.name }} ({{ room.building?.name }})
        </ion-select-option>
      </ion-select>
    </ion-item>
    <div *ngIf="reservationForm.get('classroomId')?.touched && reservationForm.get('classroomId')?.invalid" class="text-red-500 text-sm px-4">
      El aula es obligatoria.
    </div>

    <ion-item class="mb-2" *ngIf="isAdminOrCoordinator">
      <ion-label position="stacked">Asignar a Usuario</ion-label>
      <ion-select formControlName="userId" placeholder="Selecciona usuario">
        <ion-select-option *ngFor="let user of users" [value]="user.id">
          {{ user.name }} ({{ user.role }})
        </ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item class="mb-2">
      <ion-label position="stacked">Propósito / Materia</ion-label>
      <ion-input formControlName="purpose" type="text" placeholder="Ej. Clase de Matemáticas"></ion-input>
    </ion-item>
    <div *ngIf="reservationForm.get('purpose')?.touched && reservationForm.get('purpose')?.invalid" class="text-red-500 text-sm px-4">
      El propósito es obligatorio.
    </div>

    <div *ngIf="reservationType === 'single'">
      <ion-item class="mb-2">
        <ion-label position="stacked">Fecha</ion-label>
        <ion-datetime-button datetime="datetime"></ion-datetime-button>
        <ion-modal [keepContentsMounted]="true">
          <ng-template>
            <ion-datetime id="datetime" presentation="date" formControlName="date" [min]="minDateISO"></ion-datetime>
          </ng-template>
        </ion-modal>
      </ion-item>
    </div>

    <div *ngIf="reservationType === 'semester'">
      <ion-item class="mb-2">
        <ion-label position="stacked">Inicio Semestre</ion-label>
        <ion-input type="date" formControlName="semesterStartDate"></ion-input>
      </ion-item>
      <ion-item class="mb-2">
        <ion-label position="stacked">Fin Semestre</ion-label>
        <ion-input type="date" formControlName="semesterEndDate"></ion-input>
      </ion-item>

      <ion-item class="mb-2">
        <ion-label position="stacked">Días de la Semana</ion-label>
        <ion-select formControlName="dayOfWeek" multiple="true" placeholder="Selecciona los días">
          <ion-select-option *ngFor="let day of daysOfWeek" [value]="day.value">{{ day.label }}</ion-select-option>
        </ion-select>
      </ion-item>
    </div>

    <div class="mt-6 mb-2">
      <h3 class="text-lg font-semibold px-2 mb-2">Selecciona el Horario</h3>
      <p class="text-xs text-gray-500 px-2 mb-2">Toca para inicio, toca otro para fin.</p>

      <div *ngIf="isLoadingAvailability" class="text-center py-4">
        <ion-spinner></ion-spinner>
      </div>

      <div class="grid grid-cols-4 gap-2 px-1" *ngIf="!isLoadingAvailability && timeSlots.length > 0">
        <div *ngFor="let slot of timeSlots"
             (click)="selectSlot(slot)"
             [ngClass]="{
               'bg-gray-100 text-gray-800 border-gray-300': slot.status === 'free',
               'bg-red-100 text-red-400 border-red-200 opacity-60 cursor-not-allowed': slot.status === 'busy',
               'bg-blue-500 text-white border-blue-600': slot.status === 'range-start' || slot.status === 'range-end',
               'bg-blue-200 text-blue-800 border-blue-300': slot.status === 'selected'
             }"
             class="border rounded p-2 text-center text-xs font-medium transition-colors duration-150 cursor-pointer">
          {{ slot.startLabel }} - {{ slot.endLabel }}
        </div>
      </div>

      <div *ngIf="!isLoadingAvailability && timeSlots.length === 0" class="text-center py-4 text-gray-500">
        No hay horarios disponibles o el aula está cerrada.
      </div>
    </div>

    <div *ngIf="reservationForm.get('startTime')?.value" class="px-4 py-2 bg-blue-50 rounded mb-4 text-blue-800 text-sm">
      Horario seleccionado:
      <strong>{{ reservationForm.get('startTime')?.value | date:'HH:mm' }}</strong> a
      <strong>{{ reservationForm.get('endTime')?.value | date:'HH:mm' }}</strong>
    </div>

    <ion-button expand="block" type="submit" [disabled]="reservationForm.invalid || isLoadingAvailability" class="mt-4">
      {{ isEditMode ? 'Guardar Cambios' : 'Crear Reserva' }}
    </ion-button>

  </form>
</ion-content>
