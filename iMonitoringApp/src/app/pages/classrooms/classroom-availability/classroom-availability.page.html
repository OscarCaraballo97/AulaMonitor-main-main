<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/app/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Disponibilidad de Aulas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding bg-gray-100 dark:bg-kwd-dark">
  <div class="sticky top-0 z-10 bg-gray-100 dark:bg-kwd-dark py-2 mb-4 shadow">
    <div class="flex items-center justify-around max-w-md mx-auto mb-2">
      <ion-button fill="clear" (click)="changeDay(-1)"><ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon></ion-button>
      <ion-button id="date-btn" fill="outline" class="flex-grow mx-2">{{ selectedDateYYYYMMDD | date:'dd/MM/yyyy' }}</ion-button>
      <ion-popover trigger="date-btn" [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime presentation="date" [(ngModel)]="selectedDateTimeISO" (ionChange)="onDateTimeChanged($event.detail.value)" [min]="minDate" [max]="maxDate" locale="es-CO"></ion-datetime>
        </ng-template>
      </ion-popover>
      <ion-button fill="clear" (click)="changeDay(1)"><ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon></ion-button>
    </div>
    <p class="text-center text-sm text-gray-600">{{ selectedDateYYYYMMDD | date:'EEEE, d MMMM y' | titlecase }}</p>
  </div>

  <ion-item class="mb-4 rounded-md shadow-sm">
    <ion-label position="stacked">Selecciona un Aula</ion-label>
    <ion-select interface="popover" [(ngModel)]="selectedClassroomId" (ionChange)="onClassroomSelected($event)" placeholder="Elige aula">
      <ion-select-option *ngFor="let c of allClassrooms" [value]="c.id">{{ c.name }} ({{ c.buildingName }})</ion-select-option>
    </ion-select>
  </ion-item>

  <ng-container *ngIf="selectedClassroomId && getSelectedClassroomDetails() as room">
    <ion-card>
      <ion-card-content>
        <h2 class="text-lg font-bold text-primary mb-2">{{ room.name }} ({{ room.buildingName }})</h2>

        <div *ngIf="isLoadingSlots" class="text-center py-4"><ion-spinner></ion-spinner></div>

        <div *ngIf="!isLoadingSlots && timeSlotsForSelectedClassroom.length > 0">
           <div class="flex justify-center gap-4 text-xs mb-3">
              <div class="flex items-center"><div class="w-3 h-3 bg-green-100 border border-green-200 mr-1 rounded"></div> Libre</div>
              <div class="flex items-center"><div class="w-3 h-3 bg-red-200 border border-red-300 mr-1 rounded"></div> Ocupado</div>
           </div>
           <div class="grid grid-cols-4 gap-2">
              <ion-chip *ngFor="let slot of timeSlotsForSelectedClassroom" [ngClass]="getSlotClass(slot)" (click)="onSlotClick(slot)" class="justify-center flex-col h-auto py-2">
                 <ion-label class="text-xs font-bold">{{ slot.time }}</ion-label>
                 <ion-label class="text-[0.65rem] opacity-75">- {{ slot.endTimeLabel }}</ion-label>
              </ion-chip>
           </div>
        </div>

        <div *ngIf="!isLoadingSlots && timeSlotsForSelectedClassroom.length === 0" class="text-center py-4 text-gray-500">
           No hay horarios disponibles (Cerrado).
        </div>
      </ion-card-content>
    </ion-card>
  </ng-container>
</ion-content>
