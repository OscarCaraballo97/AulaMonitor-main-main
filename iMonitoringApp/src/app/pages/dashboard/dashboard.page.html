<ion-header>
  <ion-toolbar color="primary" class="dark:bg-kwd-darker">
    <ion-buttons slot="start">
      <ion-menu-button class="dark:text-kwd-light"></ion-menu-button>
    </ion-buttons>
    <ion-title class="dark:text-kwd-light">Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="handleRefresh()" fill="clear" class="dark:text-kwd-light">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding bg-gray-100 dark:bg-kwd-dark">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content class="dark:text-kwd-light"></ion-refresher-content>
  </ion-refresher>

  <div class="max-w-4xl mx-auto">
    <div *ngIf="isLoading && !currentUser" class="flex justify-center items-center py-10">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="ml-3 text-gray-600 dark:text-gray-300">Cargando...</p>
    </div>

    <div *ngIf="!isLoading && currentUser">
      <div class="mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-kwd-light">{{ greetings }}, {{ currentUser.name }}!</h1>
        <p class="text-gray-600 dark:text-gray-400">Bienvenido de nuevo a AulaMonitor.</p>
      </div>

      <div *ngIf="userRole === RolEnum.ADMIN || userRole === RolEnum.COORDINADOR" class="mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-kwd-light-tint">Resumen del Sistema</h2>
        <div *ngIf="isLoading" class="text-center mb-6"> 
            <ion-spinner name="dots" color="secondary"></ion-spinner> <p class="text-sm text-gray-500 dark:text-gray-400">Cargando datos del sistema...</p>
        </div>
        <div *ngIf="!isLoading">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <ion-card *ngIf="classroomAvailabilitySummary" class="dark:bg-kwd-darker">
                    <ion-card-header>
                        <ion-item lines="none" class="dark:bg-kwd-darker">
                            <ion-icon name="business-outline" slot="start" class="text-2xl text-blue-500 dark:text-kwd-blue-light"></ion-icon>
                            <ion-label class="dark:text-kwd-light-tint">
                                <h2 class="text-lg font-medium">Aulas Disponibles</h2>
                            </ion-label>
                        </ion-item>
                    </ion-card-header>
                    <ion-card-content class="text-center">
                        <p class="text-3xl font-semibold text-gray-700 dark:text-kwd-light">
                            {{ classroomAvailabilitySummary.availableNow || 0 }} / {{ classroomAvailabilitySummary.total || 0 }}
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Actualmente</p>
                    </ion-card-content>
                </ion-card>
                <ion-card class="dark:bg-kwd-darker">
                    <ion-card-header>
                        <ion-item lines="none" class="dark:bg-kwd-darker">
                            <ion-icon name="time-outline" slot="start" class="text-2xl text-yellow-500 dark:text-kwd-yellow"></ion-icon>
                            <ion-label class="dark:text-kwd-light-tint">
                               <h2 class="text-lg font-medium">Reservas Pendientes</h2>
                            </ion-label>
                        </ion-item>
                    </ion-card-header>
                    <ion-card-content class="text-center">
                        <p class="text-3xl font-semibold text-gray-700 dark:text-kwd-light">{{ pendingReservationsCount }}</p>
                        <ion-button expand="block" fill="clear" size="small" (click)="navigateTo('/app/reservations')" class="mt-2 text-sm dark:text-kwd-secondary">
                            Gestionar
                            <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
                        </ion-button>
                    </ion-card-content>
                </ion-card>
                <ion-card class="dark:bg-kwd-darker">
                     <ion-card-header>
                        <ion-item lines="none" class="dark:bg-kwd-darker">
                            <ion-icon name="stats-chart-outline" slot="start" class="text-2xl text-purple-500 dark:text-kwd-purple"></ion-icon>
                            <ion-label class="dark:text-kwd-light-tint">
                                <h2 class="text-lg font-medium">Estadísticas</h2>
                            </ion-label>
                        </ion-item>
                    </ion-card-header>
                    <ion-card-content>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Edificios: <strong>{{ totalBuildings }}</strong></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Aulas: <strong>{{ totalClassrooms }}</strong></p>
                        <p *ngIf="userRole === RolEnum.ADMIN" class="text-sm text-gray-600 dark:text-gray-400">Usuarios: <strong>{{ totalUsers }}</strong></p>
                    </ion-card-content>
                </ion-card>
            </div>
        </div>
      </div>

      <div class="mb-8">
        <ion-button expand="block" fill="clear" (click)="toggleMyReservationsSection()" class="my-4 dark:text-kwd-light-tint text-gray-700 font-medium text-left justify-start pl-0 text-base">
          <ion-icon [name]="showMyReservationsSection ? 'chevron-up-outline' : 'chevron-down-outline'" slot="start" aria-hidden="true"></ion-icon>
          {{ showMyReservationsSection ? 'Ocultar' : 'Ver' }} Mis Próximas Reservas
          <ion-spinner *ngIf="isLoadingUpcomingReservations && showMyReservationsSection" name="dots" slot="end" class="ml-2"></ion-spinner>
        </ion-button>

        <div *ngIf="showMyReservationsSection" class="mt-2">
          <h3 class="mb-3 text-lg font-semibold text-gray-700 dark:text-kwd-light">Mis Próximas Reservas ({{ upcomingReservations.length }})</h3>
          <div *ngIf="isLoadingUpcomingReservations" class="p-4 text-center text-gray-500 dark:text-gray-400">
            <ion-spinner name="crescent" color="secondary"></ion-spinner><p class="mt-1 text-sm">Cargando próximas reservas...</p>
          </div>
          <div *ngIf="!isLoadingUpcomingReservations && upcomingReservations.length === 0" class="p-4 text-center text-gray-500 bg-white rounded-lg shadow-md dark:bg-kwd-darker dark:text-gray-400">
            <ion-icon name="calendar-clear-outline" class="text-4xl opacity-70 mb-2"></ion-icon>
            <p>No tienes próximas reservas confirmadas.</p>
          </div>
          <ion-list *ngIf="!isLoadingUpcomingReservations && upcomingReservations.length > 0" class="rounded-lg shadow-md dark:bg-kwd-darker" lines="full">
            <ion-item *ngFor="let res of upcomingReservations" class="dark:bg-kwd-darker dark:text-kwd-light" button (click)="viewReservationDetails(res)" detail="false">
              <ion-icon [name]="res.classroom?.type === ReservationClassroomTypeEnum.LABORATORIO ? 'flask-outline' : (res.classroom?.type === ReservationClassroomTypeEnum.AUDITORIO ? 'megaphone-outline' : 'easel-outline')" slot="start" class="text-2xl" [style.color]="getEventColor(res.status)"></ion-icon>
              <ion-label>
                <h2 class="font-semibold text-sm">{{ res.purpose || 'Sin motivo' }}</h2>
                <p class="text-xs">{{ res.classroom?.name }} ({{ res.classroom?.buildingName || 'N/A' }})</p>
                <p class="text-xs">{{ res.startTime | date:'EEE, d MMM, HH:mm':'UTC':'es-CO' }} - {{ res.endTime | date:'HH:mm':'UTC':'es-CO' }}</p>
              </ion-label>
              <ion-badge slot="end" [color]="getEventColor(res.status)">{{ res.status | titlecase }}</ion-badge>
            </ion-item>
          </ion-list>
        </div>
      </div>

    </div> 

    <div *ngIf="!isLoading && !currentUser" class="flex flex-col items-center justify-center h-full text-center">
      <ion-icon name="sad-outline" class="text-5xl text-gray-400 mb-3"></ion-icon>
      <p class="text-gray-600 dark:text-gray-400">No se pudo cargar la información del usuario.</p>
      <ion-button (click)="doLogout()" fill="clear" class="mt-4 dark:text-kwd-secondary">Reintentar Login</ion-button>
    </div>
  </div>
</ion-content>